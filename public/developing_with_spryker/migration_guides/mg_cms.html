<!DOCTYPE html>
<html id="spryker-academy" lang="en-us" xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" xml:lang="en-us" data-mc-search-type="Stem" data-mc-help-system-file-name="Default.xml" data-mc-path-to-help-system="../../" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic;Default" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="Developing with Spryker|Migration Guides">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
        <meta name="author" content="Spryker Systems GmbH" />
        <meta name="title" content="Spryker Academy" />
        <meta name="msapplication-config" content="/resources/ui/images/favicons/browserconfig.xml" />
        <link rel="apple-touch-icon" sizes="180x180" href="/resources/ui/images/favicons/apple-touch-icon.png" />
        <link rel="shortcut icon" href="/resources/ui/images/favicons/favicon-32x32.png" />
        <link rel="icon" sizes="96x96" href="/resources/ui/images/favicons/favicon-96x96.png" />
        <link rel="icon" sizes="32x32" href="/resources/ui/images/favicons/favicon-32x32.png" />
        <link rel="icon" sizes="16x16" href="/resources/ui/images/favicons/favicon-16x16.png" />
        <!-- Google Tag Manager -->
        <script>/*<![CDATA[*/(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-NP24S2');/*]]>*/</script>
        <!-- End Google Tag Manager --><title>Migration Guide - CMS</title>
        <link href="../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" />
        <link href="../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" />
        <link href="../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" />
        <link href="../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" />
        <link href="../../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" />
        <link href="../../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" />
        <style>@import url('https://fonts.googleapis.com/css?family=Lato:300,400,400i,900');

</style>
        <link href="/resources/ui/css/academy-ui-typography.css" rel="stylesheet" />
        <link href="/resources/ui/css/academy-ui-app.css" rel="stylesheet" />
        <style>/*&lt;meta /&gt;*/

.button.previous-topic-button
{
	-pie-background: url('../../Skins/Default/Stylesheets/Images/navigate-previous.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.next-topic-button
{
	-pie-background: url('../../Skins/Default/Stylesheets/Images/navigate-next.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.expand-all-button
{
	-pie-background: url('../../Skins/Default/Stylesheets/Images/expand.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.print-button
{
	-pie-background: url('../../Skins/Default/Stylesheets/Images/printer.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.collapse-all-button
{
	-pie-background: url('../../Skins/Default/Stylesheets/Images/collapse.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.needs-pie
{
	behavior: url('../../Resources/Scripts/PIE-no-motw.htc');
}

</style>
        <link href="../../resources/ui/css/academy-ui-typography.css" rel="stylesheet" />
        <script src="../../Resources/Scripts/custom.modernizr.js">
        </script>
        <script src="../../Resources/Scripts/jquery.min.js">
        </script>
        <script src="../../Resources/Scripts/require.min.js">
        </script>
        <script src="../../Resources/Scripts/require.config.js">
        </script>
        <script src="../../Resources/Scripts/foundation.min.js">
        </script>
        <script src="../../Resources/Scripts/plugins.min.js">
        </script>
        <script src="../../Resources/Scripts/MadCapAll.js">
        </script>
    </head>
    <body class="t-base t-base--page js-base-template">
        <!-- Google Tag Manager (noscript) -->
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP24S2" height="0" width="0" style="display:none;visibility:hidden"></iframe>
        </noscript>
        <!-- End Google Tag Manager (noscript) -->
        <div class="t-base__header">
            <header class="o-header">
                <div class="o-header__content g-grid g-grid--container g-grid--middle"><a class="m-logo g-col g-col--sm-10 g-col--lg-2" href="/"><img class="m-logo__image" src="/resources/ui/images/logo.png" alt="Spryker Logo" /></a>
                    <nav class="m-nav-top g-col g-col--sm-2 g-col--lg-10" id="nav-top">
                        <div class="u-is-hidden--sm-xl">
                            <ul class="nocontent menu mc-component" data-mc-linked-toc="Data/Tocs/spryker_content.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                            </ul>
                        </div>
                        <div class="u-is-hidden--xl"><a class="m-nav-top__toggler js-base-template__toggler" href="#"><span class="icon icon-bars"></span></a>
                        </div>
                    </nav>
                </div>
            </header>
        </div>
        <div class="t-base__frame">
            <section class="o-search">
                <div class="g-grid g-grid--container">
                    <section class="m-search g-col g-col--sm-12">
                        <form action="/search.html" method="GET">
                            <input class="a-input a-input--expanded m-search__input" placeholder="Search in the Academy..." name="q" />
                            <button class="m-search__submit" type="submit"><span class="icon icon-search"></span>
                            </button>
                        </form>
                    </section>
                </div>
            </section>
            <section class="t-base__widgets g-grid g-grid--container g-grid--middle">
                <section class="m-breadcrumbs g-col g-col--sm-12 g-col--xl-8">
                    <div class="nocontent">
                        <div class="MCBreadcrumbsBox_0 breadcrumbs" data-mc-breadcrumbs-divider=" &gt; " data-mc-breadcrumbs-count="3" data-mc-toc="True"><span class="MCBreadcrumbsPrefix">You are here: </span>
                        </div>
                    </div>
                </section>
                <div class="g-col g-col--sm-12 g-col--xl-4 u-align-right">
                    <section class="m-widget-toolbar">
                        <div class="buttons popup-container clearfix topicToolbarProxy _Skins_topic_toolbar mc-component nocontent">
                            <div class="button-group-container-left">
                                <button class="button needs-pie previous-topic-button" title="Navigate previous">
                                    <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="previous topic" />
                                </button>
                                <button class="button needs-pie next-topic-button" title="Navigate next">
                                    <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="next topic" />
                                </button>
                                <button class="button needs-pie expand-all-button" data-state1-class="expand-all-button" data-state2-class="collapse-all-button" data-state2-title="Collapse all" title="Expand all" data-state1-title="Expand all">
                                    <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="expand all" />
                                </button>
                                <button class="button needs-pie print-button" title="Print">
                                    <img src="../../Skins/Default/Stylesheets/Images/transparent.gif" alt="print" />
                                </button>
                            </div>
                        </div>
                    </section>
                    <div class="m-widget-github js-widget-github"><a class="m-widget-github__link icon icon-github js-widget-github__link" href="https://github.com/spryker/spryker-academy" target="_blank"></a>
                    </div>
                </div>
            </section>
            <main class="t-base__main g-grid g-grid--container">
                <div class="g-col g-col--sm-12 u-is-hidden--xl">
                    <div class="m-accordion js-accordion">
                        <div class="m-accordion__header">
                            <div class="m-accordion__title js-accordion__toggler"><span class="icon icon-ellipsis-v icon--left"></span>
                    Navigation
                </div>
                        </div>
                        <div class="m-accordion__content js-accordion__content">
                            <nav class="m-nav-sidebar" id="nav-sidebar">
                                <ul class="nocontent menu mc-component" data-mc-is-context-sensitive="True" data-mc-linked-toc="Data/Tocs/spryker_content.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                <div class="t-page-sidebar__content o-content g-col g-col--sm-12 g-col--xl-8 js-anchorer js-highlighter js-widget-copy">
                    <h1>Migration Guide - CMS</h1>
                    <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Upgrading from Version 4.* to Version 5.*</a></span>
                        <div class="MCDropDownBody dropDownBody">
                            <p>CMS version 5.0 is responsible only for CMS pages and page versioning. CMS Block functionality became more flexible and moved to <a href="../module_guide/cms/cms_block/cms_block.html">CmsBlock module</a>.</p>
                            <p>If you used CMS Blocks before, you need to migrate your data to the new structure.
    If you did not use CMS Blocks in your project, you can skip the migration process.</p>
                            <p>The migration process for CMS Block data is as follows:</p>
                            <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Install CMS Block module</a></span>
                                <div class="MCDropDownBody dropDownBody">
                                    <p>To install the module <var>"spryker/cms-block": "^1.0.0"</var> with Composer is required.</p>
                                </div>
                            </div>
                            <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Perform database migration</a></span>
                                <div class="MCDropDownBody dropDownBody">
                                    <ul>
                                        <li value="1"> <var>`vendor/bin/console propel:diff`</var>, also manual review is necessary for the generated migration file</li>
                                        <li value="2"> <var>`vendor/bin/console propel:migrate`</var></li>
                                        <li value="3"> <var>`vendor/bin/console propel:model:build`</var></li>
                                    </ul>
                                    <p>After running the last command you’ll find some new classes in your project under <var>\Orm\Zed\Cms\Persistence</var> namespace. It’s important to make sure that they are extending the base classes from the core, i.e.
<var>`Orm\Zed\Cms\Persistence\SpyCmsBlock</var> extends <var>Spryker\Zed\CmsBlock\Persistence\Propel\AbstractSpyCmsBlock`</var><var>`Orm\Zed\Cms\Persistence\SpyCmsBlockQuery</var> extends <var>Spryker\Zed\CmsBlock\Persistence\Propel\AbstractSpyCmsBlockQuery.`</var> </p>
                                    <p>The same is for <var>SpyCmsBlockGlossaryKeyMapping</var>, <var>SpyCmsBlockGlossaryKeyMappingQuery</var>, <var>SpyCmsBlockTemplate</var>, <var>SpyCmsBlockTemplateQuery</var>.</p>
                                </div>
                            </div>
                            <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Move templates</a></span>
                                <div class="MCDropDownBody dropDownBody">
                                    <p>Now your block and page templates can be found in <var>src/Pyz/Yves/Cms/Theme/default/template/*</var> or <var>src/Pyz/Shared/Cms/Theme/default/template/*</var> folders.</p>
                                    <p>Move CMS Block templates to <var>src/Pyz/Shared/CmsBlock/Theme/default/template/*</var> folder.</p>
                                </div>
                            </div>
                            <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Run migration script</a></span>
                                <div class="MCDropDownBody dropDownBody">
                                    <p>For quick and smooth migration we have prepared a migration script. You can find it below.</p>
                                    <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click here to expand the code sample</a></span>
                                        <div class="MCDropDownBody dropDownBody"><pre><code class="php">
&lt;?php

/**
 * Copyright © 2016-present Spryker Systems GmbH. All rights reserved.
 * Use of this software requires acceptance of the Evaluation License Agreement. See LICENSE file.
 */

namespace Pyz\Zed\CmsBlock\Communication\Console;

use Orm\Zed\Cms\Persistence\SpyCmsPage;
use Orm\Zed\Cms\Persistence\SpyCmsPageQuery;
use Orm\Zed\Cms\Persistence\SpyCmsTemplate;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlock;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlockGlossaryKeyMapping;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlockGlossaryKeyMappingQuery;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlockQuery;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlockTemplate;
use Orm\Zed\CmsBlock\Persistence\SpyCmsBlockTemplateQuery;
use Orm\Zed\CmsBlockCategoryConnector\Persistence\SpyCmsBlockCategoryConnector;
use Propel\Runtime\ActiveQuery\Criteria;
use Propel\Runtime\Propel;
use Spryker\Zed\Kernel\Communication\Console\Console;
use Spryker\Zed\Kernel\Locator;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Input\InputOption;
use Symfony\Component\Console\Output\OutputInterface;

/**
 * @method \Spryker\Zed\CmsBlock\Communication\CmsBlockCommunicationFactory getFactory()
 * @method \Spryker\Zed\CmsBlock\Business\CmsBlockFacade getFacade()
 */
class CmsToCmsBlockDataMigration extends Console
{

    const COMMAND_NAME = 'cms-cms-block:migrate';
    const COMMAND_DESCRIPTION = 'Migrates CMS Block data from CMS module';
    const COMMAND_ARGUMENT_DRY_RUN = 'dry-run';

    const CMS_BLOCK_RELATION_TYPE_CATEGORY = 'category';

    /**
     * @param InputInterface $input
     * @param OutputInterface $output
     *
     * @return void
     */
    public function execute(InputInterface $input, OutputInterface $output)
    {
        $connection = Propel::getConnection();

        $spyCmsBlocks = SpyCmsBlockQuery::create()
            -&gt;filterByFkPage(null, Criteria::ISNOTNULL)
            -&gt;filterByFkTemplate(null, Criteria::ISNULL)
            -&gt;find();

        $spyCmsBlocksCount = count($spyCmsBlocks);

        $output-&gt;writeln(sprintf('Processing %s blocks...', $spyCmsBlocksCount));

        foreach ($spyCmsBlocks as $spyCmsBlock) {
            $spyCmsPage = SpyCmsPageQuery::create()
                -&gt;filterByIdCmsPage($spyCmsBlock-&gt;getFkPage())
                -&gt;findOne();

            try {
                $connection-&gt;beginTransaction();

                //Migration of template
                $spyCmsTemplate = $spyCmsPage-&gt;getCmsTemplate();
                $spyCmsBlockTemplate = $this-&gt;createCmsBlockTemplate($spyCmsTemplate);
                $spyCmsBlock-&gt;setFkTemplate($spyCmsBlockTemplate-&gt;getIdCmsBlockTemplate());

                //Migration of common data fields
                $spyCmsBlock-&gt;setValidFrom($spyCmsPage-&gt;getValidFrom());
                $spyCmsBlock-&gt;setValidTo($spyCmsPage-&gt;getValidTo());
                $spyCmsBlock-&gt;setIsActive($spyCmsPage-&gt;getIsActive());

                //Migration of category relation
                if ($spyCmsBlock-&gt;getType() === self::CMS_BLOCK_RELATION_TYPE_CATEGORY) {
                    if (!$this-&gt;isCategoryConnectorInstalled()) {
                        $output-&gt;writeln('To import relation to Category you need to install CmsBlockCategoryConnector module');
                        $connection-&gt;rollBack();
                        continue;
                    }

                    $this-&gt;createCmsBlockCategoryConnector($spyCmsBlock);
                }

                $spyCmsBlock-&gt;save();
                $this-&gt;migrateGlossary($spyCmsPage, $spyCmsBlock);

                $connection-&gt;commit();
            } catch (\Exception $exception) {
                $output-&gt;writeln('ERROR: ' . $exception-&gt;getMessage());
                $connection-&gt;rollBack();
            }
        }

        $output-&gt;writeln('Successfully finished.');
    }

    /**
     * @param \Orm\Zed\Cms\Persistence\SpyCmsTemplate $spyCmsTemplate
     *
     * @return \Orm\Zed\CmsBlock\Persistence\SpyCmsBlockTemplate
     */
    protected function createCmsBlockTemplate(SpyCmsTemplate $spyCmsTemplate)
    {
        $spyCmsBlockTemplate = SpyCmsBlockTemplateQuery::create()
            -&gt;filterByTemplatePath($spyCmsTemplate-&gt;getTemplatePath())
            -&gt;findOne();

        if (empty($spyCmsBlockTemplate)) {
            $spyCmsBlockTemplate = new SpyCmsBlockTemplate();
            $spyCmsBlockTemplate-&gt;setTemplateName($spyCmsTemplate-&gt;getTemplateName());
            $spyCmsBlockTemplate-&gt;setTemplatePath($spyCmsTemplate-&gt;getTemplatePath());
            $spyCmsBlockTemplate-&gt;save();
        }

        return $spyCmsBlockTemplate;
    }

    /**
     * @param SpyCmsBlock $spyCmsBlock
     *
     * @return SpyCmsBlockCategoryConnector
     */
    protected function createCmsBlockCategoryConnector(SpyCmsBlock $spyCmsBlock)
    {
        $spyCmsBlockRelation = new SpyCmsBlockCategoryConnector();
        $spyCmsBlockRelation-&gt;setFkCmsBlock($spyCmsBlock-&gt;getIdCmsBlock());
        $spyCmsBlockRelation-&gt;setFkCategory($spyCmsBlock-&gt;getValue());
        $spyCmsBlockRelation-&gt;save();

        return $spyCmsBlockRelation;
    }

    /**
     * @param SpyCmsPage $spyCmsPage
     * @param SpyCmsBlock $spyCmsBlock
     *
     * @return void
     */
    protected function migrateGlossary(SpyCmsPage $spyCmsPage, SpyCmsBlock $spyCmsBlock)
    {
        foreach ($spyCmsPage-&gt;getSpyCmsGlossaryKeyMappings() as $cmsGlossaryKeyMapping) {
            $exists = SpyCmsBlockGlossaryKeyMappingQuery::create()
                -&gt;filterByFkCmsBlock($spyCmsBlock-&gt;getIdCmsBlock())
                -&gt;filterByPlaceholder($cmsGlossaryKeyMapping-&gt;getPlaceholder())
                -&gt;exists();

            if (!$exists) {
                $spyCmsBlockGlossaryKeyMapping = new SpyCmsBlockGlossaryKeyMapping();
                $spyCmsBlockGlossaryKeyMapping-&gt;setFkCmsBlock($spyCmsBlock-&gt;getIdCmsBlock());
                $spyCmsBlockGlossaryKeyMapping-&gt;setFkGlossaryKey($cmsGlossaryKeyMapping-&gt;getFkGlossaryKey());
                $spyCmsBlockGlossaryKeyMapping-&gt;setPlaceholder($cmsGlossaryKeyMapping-&gt;getPlaceholder());
                $spyCmsBlockGlossaryKeyMapping-&gt;save();
            }
        }

    }


    /**
     * @return void
     */
    protected function configure()
    {
        parent::configure();

        $this-&gt;setName(static::COMMAND_NAME);
        $this-&gt;setDescription(static::COMMAND_DESCRIPTION);

        $this-&gt;addOption(
            static::COMMAND_ARGUMENT_DRY_RUN,
            null,
            InputOption::VALUE_REQUIRED,
            'Run without database changes'
        );
    }

    /**
     * @return bool
     */
    protected function isCategoryConnectorInstalled()
    {
        return class_exists(SpyCmsBlockCategoryConnector::class);
    }

}
        </code></pre>
                                        </div>
                                    </div>
                                    <p>Copy script to <var>src/Pyz/Zed/CmsBlock/Communication/Console/CmsToCmsBlockDataMigration.php</var> and register it in <var>Pyz\Zed\Console\ConsoleDependencyProvider</var>.</p><code class="php">
&lt;?php
namespace Pyz\Zed\Console;

class ConsoleDependencyProvider extends SprykerConsoleDependencyProvider
{
    public function getConsoleCommands(Container $container)
    {
        $commands = [
          ...
          CmsToCmsBlockDataMigration()
        ];

        ...
    }
}
</code>
                                    <p>Run the script with the command <var>vendor/bin/console cms-cms-block:migrate</var>.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Upgrading from Version 3.* to Version 4.*</a></span>
                        <div class="MCDropDownBody dropDownBody">
                            <p>CMS Version 5.0 has a new concept for showing pages in the frontend. In previous CMS versions, after creating a CMS page and running the collectors, we were able to see the page in the frontend, but now this has changed. After creating a cms page, another step  called <var>Publish</var> is needed to display the page in the frontend. Publish aggregates all CMS related data and puts it to our new CMS table <var>spy_cms_version</var>. The new collectors push this data to the frontend storage and search.</p>
                            <p class="important">Before upgrading, make sure that you do not use any deprecated code from version 3|4.*. Check the description of the deprecated code (inside the code) to see what you will need to use instead.</p>
                        </div>
                    </div>
                    <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Database Migration</a></span>
                        <div class="MCDropDownBody dropDownBody">
                            <p>To start Dabase migration, run the following commands:</p>
                            <ul>
                                <li value="1"><var>vendor/bin/console propel:diff</var>, manual review is necessary for the generated migration file.</li>
                                <li value="2"><var>vendor/bin/console propel:migrate</var>
                                </li>
                                <li value="3"><var>vendor/bin/console propel:model:build</var>
                                </li>
                            </ul>
                            <p>After running the last command, you will find some new classes in your project under the <var>\Orm\Zed\Cms\Persistence</var> namespace. It is important to make sure that they are extending the base classes from the core, i.e.</p>
                            <ul>
                                <li value="1"><var>Orm\Zed\Cms\Persistence\SpyCmsVersion</var> extends <var>Spryker\Zed\Cms\Persistence\Propel\SpyCmsVersion</var>,</li>
                                <li value="2"><var>Orm\Zed\Cms\Persistence\SpyCmsVersionQuery</var> extends <var>Spryker\Zed\Cms\Persistence\Propel\SpyCmsVersionQuery</var></li>
                            </ul>
                            <h3>CMS Templates</h3>
                            <p>In this version we have moved all CMS templates to the <var>Shared </var>layer instead of only <var>Yves</var>, but you are still able to use the old files.</p>
                            <p><var>src/Pyz/Yves/Cms/Theme/default/template/* </var>=&gt; <var>src/Pyz/Shared/Cms/Theme/default/template/*</var></p>
                            <h3>CMS Twig Functions</h3>
                            <p>The <var>TwigCms </var>function has been improved to provide better speed and performance, it will only send query to Redis when the translations are not available. </p>
                            <p>You can still work with the current version although upgrading is highly recommended.</p>
                            <p>You can find it here: <var>src/Pyz/Yves/Cms/Plugin/TwigCms.php</var></p>
                            <h3>CMS Collector</h3>
                            <p>To push new CMS version data to the frontend storage and search, add it to <var>src/Pyz/Zed/Collector/CollectorDependencyProvider.php </var>plugin stack:</p>
                            <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click to expand the code sample</a></span>
                                <div class="MCDropDownBody dropDownBody"><pre><code class="bash">    &lt;?php
    ...
    
    use Spryker\Zed\CmsCollector\Communication\Plugin\CmsVersionPageCollectorSearchPlugin;
    use Spryker\Zed\CmsCollector\Communication\Plugin\CmsVersionPageCollectorStoragePlugin;
    
    class CollectorDependencyProvider extends SprykerCollectorDependencyProvider
    {
    ...
        $container[self::SEARCH_PLUGINS] = function (Container $container) {
          return [
              ...
              CmsConstants::RESOURCE_TYPE_PAGE =&gt; new CmsVersionPageCollectorSearchPlugin(),
          ];
        };
          
          ...
          
        $container[self::STORAGE_PLUGINS] = function (Container $container) {
           return [
                ...
                CmsConstants::RESOURCE_TYPE_PAGE =&gt; new CmsVersionPageCollectorStoragePlugin(),
                ...
           ];
    };
    
    ...
    ?&gt;
</code></pre>
                                </div>
                            </div>
                            <h3>CMS User Interaction</h3>
                            <p>When a CMS page is published, we also store/show user information for this action. To store and show user information, register two new plugins from the new <var>CmsUserConnector <span class="Generalbundle/module">module</span>,</var>.</p>
                            <p>Add them here: <var>src/Pyz/Zed/Cms/CmsDependencyProvider.php</var></p>
                            <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click to expand the code sample</a></span>
                                <div class="MCDropDownBody dropDownBody"><pre><code class="bash">&lt;?php
namespace Pyz\Zed\Cms;

use Spryker\Zed\Cms\CmsDependencyProvider as SprykerCmsDependencyProvider;
use Spryker\Zed\CmsUserConnector\Communication\Plugin\UserCmsVersionPostSavePlugin;
use Spryker\Zed\CmsUserConnector\Communication\Plugin\UserCmsVersionTransferExpanderPlugin;
use Spryker\Zed\Kernel\Container;

class CmsDependencyProvider extends SprykerCmsDependencyProvider
{

    protected function getPostSavePlugins(Container $container)
    {
        return [
            new UserCmsVersionPostSavePlugin()
        ];
    }

    protected function getTransferExpanderPlugins(Container $container)
    {
        return [
            new UserCmsVersionTransferExpanderPlugin()
        ];
    }
}
?&gt;</code></pre>
                                </div>
                            </div>
                            <h3>CMS Data Importer</h3>
                            <p>To publish pages after importing, add this into your CMS Importer class:</p>
                            <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click to expand the code sample</a></span>
                                <div class="MCDropDownBody dropDownBody"><pre><code class="bash">    &lt;?php
    
    /**
     * @param array $data
     *
     * @return void
     */
    protected function importOne(array $data)
    {
        $page = $this-&gt;format($data);
        $templateTransfer = $this-&gt;findOrCreateTemplate($page[self::TEMPLATE]);

        $pageTransfer = $this-&gt;createPage($templateTransfer, $page);

        foreach ($this-&gt;localeFacade-&gt;getLocaleCollection() as $locale =&gt; $localeTransfer) {
            $urlTransfer = new UrlTransfer();
            $urlTransfer-&gt;setUrl($page[self::LOCALES][$locale][self::URL]);

            if ($this-&gt;urlFacade-&gt;hasUrl($urlTransfer)) {
                return;
            }

            $placeholders = $page[self::LOCALES][$locale][self::PLACEHOLDERS];

            $this-&gt;createPageUrl($pageTransfer, $urlTransfer-&gt;getUrl(), $localeTransfer);
            $this-&gt;createPlaceholder($placeholders, $pageTransfer, $localeTransfer);
        }

        $this-&gt;cmsFacade-&gt;publishWithVersion($pageTransfer-&gt;getIdCmsPage()); // Publishing the pages
    }
    ?&gt;    </code></pre>
                                </div>
                            </div>
                            <h3>Publishing Current Pages</h3>
                            <p>To publish current pages, create a console command that calls the following method:</p><pre><code class="bash">    &lt;?php
    
    protected function publishAllPages()
    {
        $spyCmsPagesEntities = SpyCmsPageQuery::create()-&gt;find();

        foreach ($spyCmsPagesEntities as $spyCmsPagesEntity) {
            $this-&gt;cmsFacade-&gt;publishWithVersion($spyCmsPagesEntity-&gt;getIdCmsPage());
        }
    ?&gt;
    </code></pre>
                            <hr class="noteInDiv" width="100%" size="0" />
                            <h2>Upgrading from Version 2.* to Version 3.*</h2>
                            <p>We have extended CMS pages with localized attributes such as name and HTML meta header information. Also CMS pages can now be marked as searchable. These changes required some changes in the database.</p>
                            <ol>
                                <li value="1">Before upgrading to the new version, make sure that you do not use any deprecated code from version 2.*. Check the description of the deprecated code to see what you will need to use instead.</li>
                                <li value="2">Database migration<ol><li value="1"><var>vendor/bin/console propel:diff</var>, also manual review is necessary for the generated migration file.</li><li value="2"><var>vendor/bin/console propel:migrate</var></li><li value="3"><var>vendor/bin/console propel:model:build</var></li><li value="4">After running the last command you’ll find some new classes in your project under <var>\Orm\Zed\Cms\Persistence</var> namespace. It’s important to make sure that they are extending the base classes from the core, i.e.<ul style="list-style-type: circle;"><li class="bullet_list" value="1"><var>Orm\Zed\Cms\Persistence\SpyCmsPageLocalizedAttributes extends Spryker\Zed\Cms\Persistence\Propel\AbstractSpyCmsPageLocalizedAttributes,</var></li><li class="bullet_list" value="2"><var>Orm\Zed\Cms\Persistence\SpyCmsPageLocalizedAttributesQuery</var> extends <var>Spryker\Zed\Cms\Persistence\Propel\AbstractSpyCmsPageLocalizedAttributesQuery</var>.</li></ul></li></ol></li>
                            </ol>
                        </div>
                    </div>
                    <p><b>See also:</b>
                    </p>
                    <ul>
                        <li value="1"><a href="../../enablement/store_administration_guide/cms/bg_cms.html">Learn how to use CMS</a>
                        </li>
                        <li value="2"><a href="mg_cms_block.html">Learn how to migrate CMS Block</a>
                        </li>
                        <li value="3"><a href="mg_cms_block_gui.html">Learn how to migrate CMS Block GUI</a>
                        </li>
                        <li value="4"><a href="mg_cms_block_collector.html">Learn how to migrate CMS Block Collector</a>
                        </li>
                        <li value="5"><a href="mg_cms_block_category_connector_console.html">Learn how to migrate CMS Block Category Connector</a>
                        </li>
                        <li value="6"><a href="mg_cms_collector.html">Learn how to migrate CMS Collector</a>
                        </li>
                    </ul>
                    <p>&#160;</p>
                </div>
                <div class="t-page-sidebar__sidebar g-col g-col--sm-12 g-col--xl-4 u-is-hidden--sm-xl">
                    <section class="a-box a-box--shadow">
                        <nav class="m-nav-sidebar" id="nav-sidebar">
                            <ul class="nocontent menu mc-component" data-mc-is-context-sensitive="True" data-mc-linked-toc="Data/Tocs/spryker_content.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                            </ul>
                        </nav>
                    </section>
                </div>
            </main>
            <div class="t-base__footer">
                <footer class="o-footer g-grid g-grid--middle">
                    <nav class="g-grid g-grid--container g-grid--center"><a class="o-footer__link" href="https://spryker.com/privacy-policy" target="_blank">Privacy policy</a><a class="o-footer__link" href="https://spryker.com/partneragb" target="_blank">AGB Partnerprogram</a><a class="o-footer__link" href="https://spryker.com/impressum" target="_blank">Impressum</a>
                    </nav>
                </footer>
            </div><a class="a-scroll-top js-scroll-top" href="#"><span class="a-scroll-top__icon icon icon-chevron-up"></span></a>
            <div class="t-base__overlay js-base-template__toggler">
            </div>
        </div>
        <div class="t-base__off">
            <section class="o-off-canvas">
                <nav class="m-nav-mobile" id="nav-mobile">
                    <ul class="nocontent menu mc-component" data-mc-linked-toc="Data/Tocs/spryker_content.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                    </ul>
                </nav>
            </section>
        </div>
        <script src="/resources/ui/js/academy-ui-manifest.js">
        </script>
        <script src="/resources/ui/js/academy-ui-vendor.js">
        </script>
        <script src="/resources/ui/js/academy-ui-app.js">
        </script>
    </body>
</html>