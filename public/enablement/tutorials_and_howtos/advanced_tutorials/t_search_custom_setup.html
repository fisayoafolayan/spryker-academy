<!DOCTYPE html>
<html id="spryker-academy" lang="en-us" xmlns:MadCap="http://www.madcapsoftware.com/Schemas/MadCap.xsd" xml:lang="en-us" data-mc-search-type="Stem" data-mc-help-system-file-name="Default.xml" data-mc-path-to-help-system="../../../" data-mc-target-type="WebHelp2" data-mc-runtime-file-type="Topic;Default" data-mc-preload-images="false" data-mc-in-preview-mode="false" data-mc-toc-path="Enablement|Tutorials and HowTos|Advanced Tutorials">
    <head>
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0" />
        <meta name="author" content="Spryker Systems GmbH" />
        <meta name="title" content="Spryker Academy" />
        <meta name="msapplication-config" content="/resources/ui/images/favicons/browserconfig.xml" />
        <link rel="apple-touch-icon" sizes="180x180" href="/resources/ui/images/favicons/apple-touch-icon.png" />
        <link rel="shortcut icon" href="/resources/ui/images/favicons/favicon-32x32.png" />
        <link rel="icon" sizes="96x96" href="/resources/ui/images/favicons/favicon-96x96.png" />
        <link rel="icon" sizes="32x32" href="/resources/ui/images/favicons/favicon-32x32.png" />
        <link rel="icon" sizes="16x16" href="/resources/ui/images/favicons/favicon-16x16.png" />
        <!-- Google Tag Manager -->
        <script>/*<![CDATA[*/(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-NP24S2');/*]]>*/</script>
        <!-- End Google Tag Manager --><title>Tutorial - Search Custom Setup</title>
        <link href="../../../Skins/Default/Stylesheets/Slideshow.css" rel="stylesheet" />
        <link href="../../../Skins/Default/Stylesheets/TextEffects.css" rel="stylesheet" />
        <link href="../../../Skins/Default/Stylesheets/Topic.css" rel="stylesheet" />
        <link href="../../../Skins/Default/Stylesheets/Components/Styles.css" rel="stylesheet" />
        <link href="../../../Skins/Default/Stylesheets/Components/Tablet.css" rel="stylesheet" />
        <link href="../../../Skins/Default/Stylesheets/Components/Mobile.css" rel="stylesheet" />
        <style>@import url('https://fonts.googleapis.com/css?family=Lato:300,400,400i,900');

</style>
        <link href="/resources/ui/css/academy-ui-typography.css" rel="stylesheet" />
        <link href="/resources/ui/css/academy-ui-app.css" rel="stylesheet" />
        <style>/*&lt;meta /&gt;*/

.button.previous-topic-button
{
	-pie-background: url('../../../Skins/Default/Stylesheets/Images/navigate-previous.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.next-topic-button
{
	-pie-background: url('../../../Skins/Default/Stylesheets/Images/navigate-next.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.expand-all-button
{
	-pie-background: url('../../../Skins/Default/Stylesheets/Images/expand.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.print-button
{
	-pie-background: url('../../../Skins/Default/Stylesheets/Images/printer.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.button.collapse-all-button
{
	-pie-background: url('../../../Skins/Default/Stylesheets/Images/collapse.png') no-repeat center center, linear-gradient(#ffffff, #ececec);
}

.needs-pie
{
	behavior: url('../../../Resources/Scripts/PIE-no-motw.htc');
}

</style>
        <link href="../../../resources/ui/css/academy-ui-typography.css" rel="stylesheet" />
        <script src="../../../Resources/Scripts/custom.modernizr.js">
        </script>
        <script src="../../../Resources/Scripts/jquery.min.js">
        </script>
        <script src="../../../Resources/Scripts/require.min.js">
        </script>
        <script src="../../../Resources/Scripts/require.config.js">
        </script>
        <script src="../../../Resources/Scripts/foundation.min.js">
        </script>
        <script src="../../../Resources/Scripts/plugins.min.js">
        </script>
        <script src="../../../Resources/Scripts/MadCapAll.js">
        </script>
    </head>
    <body class="t-base t-base--page js-base-template">
        <!-- Google Tag Manager (noscript) -->
        <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-NP24S2" height="0" width="0" style="display:none;visibility:hidden"></iframe>
        </noscript>
        <!-- End Google Tag Manager (noscript) -->
        <div class="t-base__header">
            <header class="o-header">
                <div class="o-header__content g-grid g-grid--container g-grid--middle"><a class="m-logo g-col g-col--sm-10 g-col--lg-2" href="/"><img class="m-logo__image" src="/resources/ui/images/logo.png" alt="Spryker Logo" /></a>
                    <nav class="m-nav-top g-col g-col--sm-2 g-col--lg-10" id="nav-top">
                        <div class="u-is-hidden--sm-xl">
                            <ul class="nocontent menu mc-component" data-mc-linked-toc="Data/Tocs/spryker_content.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                            </ul>
                        </div>
                        <div class="u-is-hidden--xl"><a class="m-nav-top__toggler js-base-template__toggler" href="#"><span class="icon icon-bars"></span></a>
                        </div>
                    </nav>
                </div>
            </header>
        </div>
        <div class="t-base__frame">
            <section class="o-search">
                <div class="g-grid g-grid--container">
                    <section class="m-search g-col g-col--sm-12">
                        <form action="/search.html" method="GET">
                            <input class="a-input a-input--expanded m-search__input" placeholder="Search in the Academy..." name="q" />
                            <button class="m-search__submit" type="submit"><span class="icon icon-search"></span>
                            </button>
                        </form>
                    </section>
                </div>
            </section>
            <section class="t-base__widgets g-grid g-grid--container g-grid--middle">
                <section class="m-breadcrumbs g-col g-col--sm-12 g-col--xl-8">
                    <div class="nocontent">
                        <div class="MCBreadcrumbsBox_0 breadcrumbs" data-mc-breadcrumbs-divider=" &gt; " data-mc-breadcrumbs-count="3" data-mc-toc="True"><span class="MCBreadcrumbsPrefix">You are here: </span>
                        </div>
                    </div>
                </section>
                <div class="g-col g-col--sm-12 g-col--xl-4 u-align-right">
                    <section class="m-widget-toolbar">
                        <div class="buttons popup-container clearfix topicToolbarProxy _Skins_topic_toolbar mc-component nocontent">
                            <div class="button-group-container-left">
                                <button class="button needs-pie previous-topic-button" title="Navigate previous">
                                    <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="previous topic" />
                                </button>
                                <button class="button needs-pie next-topic-button" title="Navigate next">
                                    <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="next topic" />
                                </button>
                                <button class="button needs-pie expand-all-button" data-state1-class="expand-all-button" data-state2-class="collapse-all-button" data-state2-title="Collapse all" title="Expand all" data-state1-title="Expand all">
                                    <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="expand all" />
                                </button>
                                <button class="button needs-pie print-button" title="Print">
                                    <img src="../../../Skins/Default/Stylesheets/Images/transparent.gif" alt="print" />
                                </button>
                            </div>
                        </div>
                    </section>
                    <div class="m-widget-github js-widget-github"><a class="m-widget-github__link icon icon-github js-widget-github__link" href="https://github.com/spryker/spryker-academy" target="_blank"></a>
                    </div>
                </div>
            </section>
            <main class="t-base__main g-grid g-grid--container">
                <div class="g-col g-col--sm-12 u-is-hidden--xl">
                    <div class="m-accordion js-accordion">
                        <div class="m-accordion__header">
                            <div class="m-accordion__title js-accordion__toggler"><span class="icon icon-ellipsis-v icon--left"></span>
                    Navigation
                </div>
                        </div>
                        <div class="m-accordion__content js-accordion__content">
                            <nav class="m-nav-sidebar" id="nav-sidebar">
                                <ul class="nocontent menu mc-component" data-mc-is-context-sensitive="True" data-mc-linked-toc="Data/Tocs/spryker_content.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                                </ul>
                            </nav>
                        </div>
                    </div>
                </div>
                <div class="t-page-sidebar__content o-content g-col g-col--sm-12 g-col--xl-8 js-anchorer js-highlighter js-widget-copy">
                    <h1>Tutorial - Search Custom Setup</h1>
                    <p>There might be instances when you need to go beyond product search or you have very specific requirements regarding search. You’re not tied to the basic mapping that ships with Spryker. You can easily roll your own and set up custom analyzer very easily. The underlaying library that gets used by Spryker is called <a href="https://github.com/ruflin/Elastica" target="_blank" title="Elastica " alt="Elastica ">Elastica</a> and you can use it to set up custom mapping and analyzers as you like.</p>
                    <h2>Custom Analyzers</h2>
                    <p>The Elasticsearch indexes get installed during installation of collectors. To add custom analyzers you will need to override <var>Spryker\Zed\Collector\Business\Internal\InstallElasticsearch</var>. Let’s create a quick example setting up a German analyzer.</p>
                    <p>Create a file called <var>InstallElasticsearch.php</var> inside the <var>Collector</var> <span class="Generalbundle/module">module</span> on the project level</p><pre><code class="bash">touch src/Pyz/Zed/Collector/Business/Internal/InstallElasticsearch.php</code></pre>
                    <p>Override the <var>createIndex()</var> method and provide your custom analyzer setup along with index creation.</p>
                    <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click to expand the code sample</a></span>
                        <div class="MCDropDownBody dropDownBody"><pre><code class="bash">&lt;?php

namespace Pyz\Zed\Collector\Business\Internal;

use Spryker\Zed\Collector\Business\Internal as SprykerInstallElasticsearch;

class InstallElasticsearch extends SprykerInstallElasticsearch 
{
    
    protected createIndex() {
        $index = $this-&gt;client-&gt;getIndex($this-&gt;indexName);

        if (!$index-&gt;exists()) {
            $index-&gt;create(
                [
                    'number_of_shards' =&gt; 4,
                    'number_of_replicas' =&gt; 1,
                    'analysis' =&gt; [
                        'filter' =&gt; [
                            'german_stop' =&gt; [
                                'type' =&gt; 'stop',
                                'stopwords' =&gt; '_german_',
                            ],
                            'german_stemmer' =&gt; [
                                'type' =&gt; 'stemmer',
                                'language' =&gt; 'light_german',
                            ],
                        ],
                    ],
                    'analyzer' =&gt; [
                        'german' =&gt; [
                            'tokenizer' =&gt; 'standard',
                            'filter' =&gt; [
                                'lowecase',
                                'german_stop',
                                'german_normalization',
                                'german_stemmer',
                            ]
                        ],
                    ],
                ]
            );
        }
    }

}</code></pre>
                        </div>
                    </div>
                    <p class="note">The <var>$index</var> variable holds an instance of <var>Elastica\Index</var>. The array that is passed to the <var>create()</var> method of that instance can contain any Elasticsearch setting. As you can see from the example above it gets used to set up the number of replicas and shards as well.</p>
                    <p>Elasticsearch provides analyzers for a lot of languages. Detailed information on how to properly set up analyzers can be found in the documentation at <a href="https://www.elastic.io/" target="_blank" title="Elastic" alt="Elastic">http://www.elastic.io/</a></p>
                    <h2>Custom Mapping</h2>
                    <p>If you have diverging requirements for product search than what Spryker is offering, you might want to set up a custom mapping. Either you have different requirements regarding aggregations/facets or you want a more fine grained document with multiple fields for each product attribute. It’s easy to override the default mapping and create your own.</p>
                    <p>The default mapping is defined in <var>Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch</var> and you will have to extend this class on project level.</p>
                    <p>Create a file called <var>InstallProductSearch.php</var> inside the <var>ProductSearch</var> <span class="Generalbundle/module">module</span> on project level</p><pre><code class="bash">touch src/Pyz/Zed/ProductSearch/Business/Internal/InstallProductSearch.php</code></pre>
                    <p>Override <var>createProductType()</var> method and install your custom mapping</p>
                    <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click to expand the code sample</a></span>
                        <div class="MCDropDownBody dropDownBody"><pre><code class="bash">&lt;?php
namespace Pyz\Zed\ProductSearch\Business\Internal;

use Elastica\Index;
use Elastica\Type\Mapping;
use Elastica\Type;
use Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch as SprykerInstallProductSearch;

class InstallProductSearch extends SprykerInstallProductSearch
{

    /**
     * @throws \RuntimeException
     *
     * @param \Elastica\Index $index
     *
     * @return void
     */
    protected function createProductType(Index $index)
    {
        $index = $this-&gt;client-&gt;getIndex($this-&gt;indexName);

        if (!$index-&gt;exists()) {
            throw new \RuntimeException(sprintf('Index %s is missing', $this-&gt;indexName));
        }

        $type = $index-&gt;getType($this-&gt;indexType);

        if ($type-&gt;exists() === true) {
            return;
        }

        $mapping = new Mapping($type);
        $mapping-&gt;setProperties([
            'title' =&gt; [
                'type' =&gt; 'string',
                'analyzer' =&gt; 'german',
            ],
            'description' =&gt; [
                'type' =&gt; 'string',
                'analyzer' =&gt; 'german',
            ],
            'price' =&gt; [
                'type' =&gt; 'integer',
            ],
        ]);
        $mapping-&gt;send();
    }</code></pre>
                        </div>
                    </div>
                    <h2>Extend Existing Mapping</h2>
                    <p>If you want to use the existing mapping that comes with Spryker but want to add additional fields, or change properties for existing fields, you will also need to override <var>Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch</var>. Follow the steps in the previous paragraph and add the file to your project level implementation.</p>
                    <p>Instead of replacing the implementation of <var>createProductType()</var> we will extend it. Unfortunately there’s a pitfall here. Elasticseach doesn’t allow to alter a mapping since that would lead to an inconsistent state of documents that are already indexed. However, there’s a workaround to still achieve out goal. We can load the currently installed mapping, delete the document type (which will also remove all documents of that type from the index) and then reinstall the mapping.</p>
                    <p>Here’s a simple example that uses our previously defined <var>german</var> analyzer for the <var>full-text</var> field</p>
                    <div class="MCDropDown MCDropDown_Open dropDown"><span class="MCDropDownHead dropDownHead"><a href="javascript:void(0);" class="MCDropDownHotSpot dropDownHotspot MCDropDownHotSpot_ MCHotSpotImage"><img class="MCDropDown_Image_Icon" src="../../../Skins/Default/Stylesheets/Images/transparent.gif" height="11" width="16" alt="Closed" data-mc-alt2="Open" />Click to expand the code sample</a></span>
                        <div class="MCDropDownBody dropDownBody"><pre><code class="bash">&lt;?php

namespace Pyz\Zed\ProductSearch\Business\Internal;

use Elastica\Index;
use Elastica\Type\Mapping;
use Elastica\Type;
use Spryker\Zed\ProductSearch\Business\Internal\InstallProductSearch as SprykerInstallProductSearch;

class InstallProductSearch extends SprykerInstallProductSearch
{

    /**
     * @param \Elastica\Index $index
     *
     * @return void
     */
    protected function createProductType(Index $index)
    {
        parent::createProductType($index);

        $type = $index-&gt;getType($this-&gt;indexType);
        $mappingProperties = $this-&gt;getExistingMappingProperties($type);

        $mappingProperties['full-text'] = [
            'type' =&gt; 'string',
            'analyzer' =&gt; 'german',
        ];

        $type-&gt;delete();

        $mapping = new Mapping($type);
        $mapping-&gt;setProperties($mappingProperties);
        $mapping-&gt;send();
    }

    /**
     * @param Elastica\Type $type
     *
     * @return array
     */
    protected function getExistingMappingProperties(Type $type)
    {
        $mapping = $type-&gt;getMapping();

        return $mapping[this-&gt;indexType]['properties'];
    }

}</code></pre>
                        </div>
                    </div>
                </div>
                <div class="t-page-sidebar__sidebar g-col g-col--sm-12 g-col--xl-4 u-is-hidden--sm-xl">
                    <section class="a-box a-box--shadow">
                        <nav class="m-nav-sidebar" id="nav-sidebar">
                            <ul class="nocontent menu mc-component" data-mc-is-context-sensitive="True" data-mc-linked-toc="Data/Tocs/spryker_content.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                            </ul>
                        </nav>
                    </section>
                </div>
            </main>
            <div class="t-base__footer">
                <footer class="o-footer g-grid g-grid--middle">
                    <nav class="g-grid g-grid--container g-grid--center"><a class="o-footer__link" href="https://spryker.com/privacy-policy" target="_blank">Privacy policy</a><a class="o-footer__link" href="https://spryker.com/partneragb" target="_blank">AGB Partnerprogram</a><a class="o-footer__link" href="https://spryker.com/impressum" target="_blank">Impressum</a>
                    </nav>
                </footer>
            </div><a class="a-scroll-top js-scroll-top" href="#"><span class="a-scroll-top__icon icon icon-chevron-up"></span></a>
            <div class="t-base__overlay js-base-template__toggler">
            </div>
        </div>
        <div class="t-base__off">
            <section class="o-off-canvas">
                <nav class="m-nav-mobile" id="nav-mobile">
                    <ul class="nocontent menu mc-component" data-mc-linked-toc="Data/Tocs/spryker_content.js" data-mc-side-menu="True" data-mc-max-depth="1" data-mc-include-icon="False" data-mc-include-indicator="False" data-mc-include-children="True" data-mc-include-siblings="True" data-mc-include-parent="True" data-mc-toc="True">
                    </ul>
                </nav>
            </section>
        </div>
        <script src="/resources/ui/js/academy-ui-manifest.js">
        </script>
        <script src="/resources/ui/js/academy-ui-vendor.js">
        </script>
        <script src="/resources/ui/js/academy-ui-app.js">
        </script>
    </body>
</html>